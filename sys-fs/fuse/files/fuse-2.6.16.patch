Index: kernel/file.c
===================================================================
RCS file: /cvsroot/fuse/fuse/kernel/file.c,v
retrieving revision 1.94
retrieving revision 1.94.2.1
diff -u -r1.94 -r1.94.2.1
--- kernel/file.c       6 Jan 2006 18:29:39 -0000       1.94
+++ kernel/file.c       18 Jan 2006 12:17:33 -0000      1.94.2.1
@@ -675,9 +675,15 @@
 	struct inode *inode = file->f_dentry->d_inode;
 	ssize_t res;
 	/* Don't allow parallel writes to the same file */
+#ifdef KERNEL_2_6_16_PLUS
+	mutex_lock(&inode->i_mutex);
+	res = fuse_direct_io(file, buf, count, ppos, 1);
+	mutex_unlock(&inode->i_mutex);
+#else
 	down(&inode->i_sem);
 	res = fuse_direct_io(file, buf, count, ppos, 1);
 	up(&inode->i_sem);
+#endif
 	return res;
 }

Index: kernel/fuse_i.h
===================================================================
RCS file: /cvsroot/fuse/fuse/kernel/fuse_i.h,v
retrieving revision 1.99
retrieving revision 1.99.2.1
diff -u -r1.99 -r1.99.2.1
--- kernel/fuse_i.h     14 Jan 2006 14:47:21 -0000      1.99
+++ kernel/fuse_i.h     18 Jan 2006 12:17:33 -0000      1.99.2.1
@@ -40,6 +40,9 @@
 #  if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,13)
 #    define KERNEL_2_6_13_PLUS
 #  endif
+#  if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,16)
+#    define KERNEL_2_6_16_PLUS
+#  endif
 #endif

 #include "config.h"
