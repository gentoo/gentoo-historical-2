--- asterisk-1.0.8/asterisk.c.orig	2005-05-16 05:04:58.000000000 +0200
+++ asterisk-1.0.8/asterisk.c	2005-06-25 09:45:18.763669088 +0200
@@ -1581,7 +1581,9 @@
 	int num;
 	char *buf;
 	char *runuser=NULL, *rungroup=NULL;
-	struct pollfd silly_macos[1];	
+	struct pollfd silly_macos[1];
+	gid_t runasgid = 0;
+	uid_t runasuid = 0;
 
 	/* Remember original args for restart */
 	if (argc > sizeof(_argv) / sizeof(_argv[0]) - 1) {
@@ -1709,12 +1711,7 @@
 			ast_log(LOG_WARNING, "No such group '%s'!\n", rungroup);
 			exit(1);
 		}
-		if (setgid(gr->gr_gid)) {
-			ast_log(LOG_WARNING, "Unable to setgid to %d (%s)\n", gr->gr_gid, rungroup);
-			exit(1);
-		}
-		if (option_verbose)
-			ast_verbose("Running as group '%s'\n", rungroup);
+		runasgid = gr->gr_gid;
 	}
 
 	if (runuser) {
@@ -1724,8 +1721,25 @@
 			ast_log(LOG_WARNING, "No such user '%s'!\n", runuser);
 			exit(1);
 		}
-		if (setuid(pw->pw_uid)) {
-			ast_log(LOG_WARNING, "Unable to setuid to %d (%s)\n", pw->pw_uid, runuser);
+		runasuid = pw->pw_uid;
+	}
+
+	if (runasgid) {
+		if (setgid(runasgid)) {
+			ast_log(LOG_WARNING, "Unable to setgid to %d (%s)\n", runasgid, rungroup);
+			exit(1);
+		}
+		if (option_verbose)
+			ast_verbose("Running as group '%s'\n", rungroup);
+	}
+
+	if (runasuid) {
+		if(initgroups(runuser, runasgid) < 0) {
+			ast_log(LOG_WARNING, "Unable to set supplemental groups for %s\n", runuser);
+			exit(1);		
+		}
+		if (setuid(runasuid)) {
+			ast_log(LOG_WARNING, "Unable to setuid to %d (%s)\n", runasuid, runuser);
 			exit(1);
 		}
 		if (option_verbose)
