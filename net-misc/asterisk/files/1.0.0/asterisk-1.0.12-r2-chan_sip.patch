Ports from <http://svn.digium.com/view/asterisk?rev=57478&view=rev>,
<http://svn.digium.com/view/asterisk?rev=59038&view=rev>
More information at <http://bugs.gentoo.org/169616> and
<http://bugs.gentoo.org/171467>.
--- asterisk-1.0.12/channels/chan_sip.c	2005-11-29 13:24:39.000000000 -0500
+++ asterisk-1.0.12-r2/channels/chan_sip.c	2007-03-19 15:32:08.000000000 -0400
@@ -7293,6 +7293,12 @@
 		   increasing */
 		p->icseq = seqno;
 
+	if (!e && (strcasecmp(cmd, "INVITE") == 0 || strcasecmp(cmd, "SUBSCRIBE") == 0 || strcasecmp(cmd, "REGISTER") == 0 || strcasecmp(cmd, "NOTIFY") == 0)) {
+		transmit_response(p, "503 Server error", req);
+		p->needdestroy = 1;
+		return -1;
+	}
+
 	/* Initialize the context if it hasn't been already */
 	if (!strcasecmp(cmd, "OPTIONS")) {
 		res = get_destination(p, req);
@@ -7790,6 +7796,10 @@
 		if (sscanf(e, "%i %n", &respid, &len) != 1) {
 			ast_log(LOG_WARNING, "Invalid response: '%s'\n", e);
 		} else {
+			if (respid <= 0) {
+				ast_log(LOG_WARNING, "Invalid SIP response code: '%d'\n", respid);
+				return 0;
+			}
 			handle_response(p, respid, e + len, req,ignore);
 		}
 	} else {
