--- mga_vid.c.orig	Fri Dec  7 20:15:07 2001
+++ mga_vid.c	Mon Dec 17 00:25:44 2001
@@ -48,6 +48,10 @@
 #include <asm/mtrr.h>
 #endif
 
+#ifdef CONFIG_DEVFS_FS
+#include <linux/devfs_fs_kernel.h>
+#endif
+
 #include <asm/uaccess.h>
 #include <asm/system.h>
 #include <asm/io.h>
@@ -77,6 +81,9 @@
 
 MODULE_AUTHOR("Aaron Holtzman <aholtzma@engr.uvic.ca>");
 
+#ifdef CONFIG_DEVFS_FS
+static devfs_handle_t dev_handle = NULL;
+#endif
 
 typedef struct bes_registers_s
 {
@@ -1022,7 +1029,16 @@
 		}
 	}
 
+#ifdef CONFIG_DEVFS_FS
+	if ((dev_handle = devfs_register(
+		NULL,
+		"mga_vid", DEVFS_FL_NONE,
+		MGA_VID_MAJOR, 0,
+		S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP | S_IFCHR,
+		&mga_vid_fops, NULL)) == NULL)
+#else
 	if(register_chrdev(MGA_VID_MAJOR, "mga_vid", &mga_vid_fops))
+#endif
 	{
 		printk(KERN_ERR "mga_vid: unable to get major: %d\n", MGA_VID_MAJOR);
 		return -EIO;
@@ -1031,7 +1047,11 @@
 	if (!mga_vid_find_card())
 	{
 		printk(KERN_ERR "mga_vid: no supported devices found\n");
+#ifdef CONFIG_DEVFS_FS
+		devfs_unregister(dev_handle);
+#else
 		unregister_chrdev(MGA_VID_MAJOR, "mga_vid");
+#endif
 		return -EINVAL;
 	}
 	
@@ -1056,6 +1076,11 @@
 
 	//FIXME turn off BES
 	printk(KERN_INFO "mga_vid: Cleaning up module\n");
+#ifdef CONFIG_DEVFS_FS
+	devfs_unregister(dev_handle);
+#else
 	unregister_chrdev(MGA_VID_MAJOR, "mga_vid");
+#endif
+	
 }
 
