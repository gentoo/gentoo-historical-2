--- usr/src/nv/conftest.sh.old	2004-06-30 16:08:25.863017584 +1000
+++ usr/src/nv/conftest.sh	2004-06-30 17:19:33.415251032 +1000
@@ -195,8 +195,10 @@
         # 2.6 and newer kernels, and the old Makefile for kernels older
         # than 2.6.
         #
-        if [ "$SYSSRC" ]; then
-            KERNEL_INCLUDE=$SYSSRC/include
+        if [ "$KV_OUT" ]; then
+            KERNEL_INCLUDE=$KV_OUT/include
+	elif [ "$SYSSRC" ]; then
+	    KERNEL_INCLUDE=$SYSSRC/include
         elif [ "$SYSINCLUDE" ]; then
             KERNEL_INCLUDE=$SYSINCLUDE
         else
--- usr/src/nv/Makefile.kbuild.orig	2004-06-30 16:16:47.991682424 +1000
+++ usr/src/nv/Makefile.kbuild	2004-06-30 17:23:24.047189648 +1000
@@ -93,6 +93,11 @@
 ifdef SYSSRC
   KERNEL_SOURCES := $(SYSSRC)
   KERNEL_HEADERS := -I$(KERNEL_SOURCES)/include
+  ifdef KV_OUT
+    ifneq ($(SYSSRC),$(KV_OUT))
+      KERNEL_HEADERS += -I$(KV_OUT)/include
+    endif
+  endif
   MODULE_ROOT    := /lib/modules/$(shell sh $(src)/conftest.sh get_uname)/kernel/drivers
 else
   KERNEL_SOURCES := /lib/modules/$(shell uname -r)/build
@@ -119,7 +124,12 @@
   MODULE_OBJECT := $(MODULE_NAME).ko
 
   # We need this for the conftest.sh tests to work
-  KERNEL_HEADERS += -I$(KERNEL_SOURCES)/include/asm/mach-generic
+  ifneq ($(SYSSRC),$(KV_OUT))
+    KERNEL_HEADERS += -I$(KV_OUT)/include2/asm/mach-generic
+    KERNEL_HEADERS += -I$(KV_OUT)/include2
+  else
+    KERNEL_HEADERS += -I$(KERNEL_SOURCES)/include/asm/mach-generic
+  endif
 endif
 
 #
@@ -191,7 +201,7 @@
 # KBUILD build parameters.
 #
 
-KBUILD_PARAMS := -C $(KERNEL_SOURCES) SUBDIRS=$(PWD)
+KBUILD_PARAMS := -C $(KERNEL_SOURCES) M=$(PWD)
 
 #
 # NVIDIA sanity checks.
