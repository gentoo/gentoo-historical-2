From: Leo 'costela' Antunes <costela@debian.org>
Date: Sat, 12 Jun 2011 23:24:11 +0200
Subject: use system libminiupnpc and libnatpmp

TODO: make this optional before forwarding upstream

Forwarded: no

Index: repo/configure.ac
===================================================================
--- repo.orig/configure.ac	2011-11-05 00:55:07.000000000 +0100
+++ repo/configure.ac	2011-11-05 00:55:24.000000000 +0100
@@ -18,7 +18,7 @@
 
 dnl AM_CONFIG_HEADER(config.h)
 AC_CONFIG_SRCDIR(libtransmission/transmission.h)
-AM_INIT_AUTOMAKE([1.9 tar-pax])
+AM_INIT_AUTOMAKE([1.9 tar-pax nostdinc])
 AC_PROG_LIBTOOL
 
 if test m4_substr(peer_id_prefix,6,1) = "0"; then
@@ -197,6 +197,20 @@
 AC_SUBST(DHT_CFLAGS)
 AC_SUBST(DHT_LIBS)
 
+dnl ----------------------------------------------------------------------------
+dnl
+dnl  miniupnp
+
+MINIUPNPC_LIBS="-lminiupnpc"
+AC_SUBST(MINIUPNPC_LIBS)
+
+dnl ----------------------------------------------------------------------------
+dnl
+dnl  natpmp
+
+NATPMP_LIBS="-lnatpmp"
+AC_SUBST(NATPMP_LIBS)
+
 
 dnl ----------------------------------------------------------------------------
 dnl
@@ -416,8 +430,6 @@
                  libtransmission/Makefile
                  utils/Makefile
                  third-party/Makefile
-                 third-party/miniupnp/Makefile
-                 third-party/libnatpmp/Makefile
                  third-party/libutp/Makefile
                  third-party/dht/Makefile
                  macosx/Makefile
Index: repo/libtransmission/Makefile.am
===================================================================
--- repo.orig/libtransmission/Makefile.am	2011-11-05 00:55:07.000000000 +0100
+++ repo/libtransmission/Makefile.am	2011-11-05 00:55:24.000000000 +0100
@@ -1,7 +1,5 @@
 AM_CPPFLAGS = \
-    -I. \
     -I$(top_srcdir) \
-    -I$(top_srcdir)/third-party/ \
     -D__TRANSMISSION__ \
     -DPACKAGE_DATA_DIR=\""$(datadir)"\"
 
@@ -68,6 +66,8 @@
     webseed.c \
     wildmat.c
 
+libtransmission_a_LDFLAGS = @MINIUPNPC_LIBS@ @NATPMP_LIBS@
+
 noinst_HEADERS = \
     announcer.h \
     announcer-common.h \
@@ -139,8 +139,8 @@
 
 apps_ldadd = \
     ./libtransmission.a  \
-    $(top_builddir)/third-party/miniupnp/libminiupnp.a \
-    $(top_builddir)/third-party/libnatpmp/libnatpmp.a \
+    @MINIUPNPC_LIBS@ \
+    @NATPMP_LIBS@ \
     @INTLLIBS@ \
     @DHT_LIBS@ \
     @LIBUTP_LIBS@ \
Index: repo/third-party/Makefile.am
===================================================================
--- repo.orig/third-party/Makefile.am	2011-11-05 00:55:07.000000000 +0100
+++ repo/third-party/Makefile.am	2011-11-05 00:55:24.000000000 +0100
@@ -4,8 +4,6 @@
 
 SUBDIRS = \
   dht \
-  libnatpmp \
-  miniupnp \
   $(UTP_DIR)
 
 EXTRA_DIST = \
Index: repo/utils/Makefile.am
===================================================================
--- repo.orig/utils/Makefile.am	2011-11-05 00:55:07.000000000 +0100
+++ repo/utils/Makefile.am	2011-11-05 00:55:24.000000000 +0100
@@ -26,8 +26,8 @@
 
 transmission_create_LDADD = \
     $(top_builddir)/libtransmission/libtransmission.a \
-    $(top_builddir)/third-party/miniupnp/libminiupnp.a \
-    $(top_builddir)/third-party/libnatpmp/libnatpmp.a \
+    @MINIUPNPC_LIBS@ \
+    @NATPMP_LIBS@ \
     @INTLLIBS@ \
     @DHT_LIBS@ \
     @LIBUTP_LIBS@ \
Index: repo/daemon/Makefile.am
===================================================================
--- repo.orig/daemon/Makefile.am	2011-11-05 00:55:07.000000000 +0100
+++ repo/daemon/Makefile.am	2011-11-05 00:55:24.000000000 +0100
@@ -20,8 +20,8 @@
 
 LDADD = \
     $(top_builddir)/libtransmission/libtransmission.a \
-    $(top_builddir)/third-party/miniupnp/libminiupnp.a \
-    $(top_builddir)/third-party/libnatpmp/libnatpmp.a \
+    @MINIUPNPC_LIBS@ \
+    @NATPMP_LIBS@ \
     @DHT_LIBS@ \
     @LIBUTP_LIBS@ \
     @LIBEVENT_LIBS@ \
Index: repo/gtk/Makefile.am
===================================================================
--- repo.orig/gtk/Makefile.am	2011-11-05 00:55:07.000000000 +0100
+++ repo/gtk/Makefile.am	2011-11-05 00:55:24.000000000 +0100
@@ -84,8 +84,8 @@
 
 transmission_gtk_LDADD = \
     $(top_builddir)/libtransmission/libtransmission.a \
-    $(top_builddir)/third-party/miniupnp/libminiupnp.a \
-    $(top_builddir)/third-party/libnatpmp/libnatpmp.a \
+    @MINIUPNPC_LIBS@ \
+    @NATPMP_LIBS@ \
     @DHT_LIBS@ \
     @LIBUTP_LIBS@ \
     @GTK_LIBS@ \
Index: repo/qt/qtr.pro
===================================================================
--- repo.orig/qt/qtr.pro	2011-11-05 00:55:07.000000000 +0100
+++ repo/qt/qtr.pro	2011-11-05 00:55:24.000000000 +0100
@@ -23,8 +23,7 @@
     LIBS += $${TRANSMISSION_TOP}/third-party/libutp/libutp.a
 }
 LIBS += $${TRANSMISSION_TOP}/third-party/dht/libdht.a
-LIBS += $${TRANSMISSION_TOP}/third-party/miniupnp/libminiupnp.a
-LIBS += $${TRANSMISSION_TOP}/third-party/libnatpmp/libnatpmp.a
+LIBS += -lminiupnpc -lnatpmp
 unix: LIBS += -L$${EVENT_TOP}/lib -lz -lrt
 win32:DEFINES += QT_DBUS
 win32:LIBS += -levent-2.0 -lws2_32 -lintl
Index: repo/cli/Makefile.am
===================================================================
--- repo.orig/cli/Makefile.am	2011-11-05 00:55:07.000000000 +0100
+++ repo/cli/Makefile.am	2011-11-05 00:55:24.000000000 +0100
@@ -18,8 +18,8 @@
 
 transmission_cli_LDADD = \
     $(top_builddir)/libtransmission/libtransmission.a \
-    $(top_builddir)/third-party/libnatpmp/libnatpmp.a \
-    $(top_builddir)/third-party/miniupnp/libminiupnp.a \
+    @NATPMP_LIBS@ \
+    @MINIUPNPC_LIBS@ \
     @DHT_LIBS@ \
     @LIBUTP_LIBS@ \
     @LIBEVENT_LIBS@ \
Index: repo/libtransmission/upnp.c
===================================================================
--- repo.orig/libtransmission/upnp.c	2011-11-05 00:55:07.000000000 +0100
+++ repo/libtransmission/upnp.c	2011-11-05 00:55:24.000000000 +0100
@@ -13,8 +13,8 @@
 #include <assert.h>
 #include <errno.h>
 
-#include <miniupnp/miniupnpc.h>
-#include <miniupnp/upnpcommands.h>
+#include <miniupnpc/miniupnpc.h>
+#include <miniupnpc/upnpcommands.h>
 
 #include "transmission.h"
 #include "port-forwarding.h"
Index: repo/libtransmission/natpmp.c
===================================================================
--- repo.orig/libtransmission/natpmp.c	2011-11-05 00:55:07.000000000 +0100
+++ repo/libtransmission/natpmp.c	2011-11-05 00:55:24.000000000 +0100
@@ -17,7 +17,7 @@
 #include <event2/util.h> /* evutil_inet_ntop() */
 
 #define ENABLE_STRNATPMPERR
-#include <libnatpmp/natpmp.h>
+#include <natpmp.h>
 
 #include "transmission.h"
 #include "natpmp.h"
Index: repo/third-party/libutp/utp.cpp
===================================================================
--- repo.orig/third-party/libutp/utp.cpp	2011-11-05 00:55:07.000000000 +0100
+++ repo/third-party/libutp/utp.cpp	2011-11-05 00:55:24.000000000 +0100
@@ -1,4 +1,4 @@
-#include <StdAfx.h>
+#include "StdAfx.h"
 
 #include "utp.h"
 #include "templates.h"
