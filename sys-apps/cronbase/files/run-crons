#!/bin/sh
#
# $Header: /var/cvsroot/gentoo-x86/sys-apps/cronbase/files/run-crons,v 1.4 2002/06/21 09:25:48 bangert Exp $
#
# 20 Apr 2002; Thilo Bangert <bangert@gentoo.org> run-crons:
#
# moved lastrun directory to /var/spool/cron/lastrun
#
#
# Author: Achim Gottinger <achim@gentoo.org>
#
# Mostly copied from SuSE
#
# this script looks into /etc/cron.[hourly|daily|weekly|monthly]
# for scripts to be executed. The info about last run is stored in 
# /var/spool/cron/lastrun

mkdir -p /var/spool/cron/lastrun

#

for CRONDIR in /etc/cron.{hourly,daily,weekly,monthly}
do
   
    test -d $CRONDIR || continue
    BASE=${CRONDIR##*/}
    test -e /var/spool/cron/lastrun/$BASE && {

	case $BASE in
	    cron.hourly)
		#> 59 min =~ >= 60 min
		TIME="-cmin  +59 " ;;
	    cron.daily)
		#>= 1 day
		TIME="-ctime +1  -or -ctime 1"  ;;
	    cron.weekly)
		#>= 7 days
		TIME="-ctime +7  -or -ctime 7"  ;;
	    cron.monthly)
		#>= 30 days
		TIME="-ctime +30 -or -ctime 30" ;;
	esac
	find /var/spool/cron/lastrun/$BASE $TIME -exec rm {} \;
    }
    if test ! -e /var/spool/cron/lastrun/$BASE ; then
	touch /var/spool/cron/lastrun/$BASE

	set +e
	for SCRIPT in $CRONDIR/*
	do
	    test -d $SCRIPT && continue
	    if test -x $SCRIPT ; then
		$SCRIPT
	    fi
	done
    fi
done

#

touch /var/spool/cron/lastrun
find /var/spool/cron/lastrun -newer /var/spool/cron/lastrun -exec rm {} \;

