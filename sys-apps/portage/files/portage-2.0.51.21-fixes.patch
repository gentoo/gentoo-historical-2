diff -uNr portage-2.0.51.21/ChangeLog portage-2.0.51.21-r1/ChangeLog
--- portage-2.0.51.21/ChangeLog	2005-05-01 23:53:46.000000000 +0900
+++ portage-2.0.51.21-r1/ChangeLog	2005-05-05 13:08:42.000000000 +0900
@@ -1,12 +1,41 @@
 # ChangeLog for Portage; the Gentoo Linux ports system 
 # Copyright 1999-2005 Gentoo Foundation; Distributed under the GPL v2
-# $Id: ChangeLog,v 1.796.2.115 2005/05/01 12:46:51 jstubbs Exp $
+# $Id: ChangeLog,v 1.796.2.122 2005/05/05 04:07:02 jstubbs Exp $
 
   MAJOR CHANGES in 2.0.51:
     1. /var/cache/edb/virtuals is no longer used at all. It's calculated now.
     2. /var/cache/edb/world is now /var/lib/portage/world.
     3. /etc/portage/profile/virtuals is _USER_ configs only.
 
+  05 May 2005; Jason Stubbs <jstubbs@gentoo.org> bin/etc-update: Fixed the
+  regex and added locale overrides to the use of cut as per bug #91159.
+
+  05 May 2005; Jason Stubbs <jstubbs@gentoo.org> cnf/make.globals: Made
+  CONFIG_PROTECT default to /etc only as packages are augmenting it via env.d
+  where necessary.
+
+  05 May 2005; Jason Stubbs <jstubbs@gentoo.org> bin/emerge: Reverted deletion
+  of apparently unused code as it was being used in the case of --noreplace.
+
+  04 May 2005; Marius Mauch <genone@gentoo.org> bin/g-cpan.pl, man/g-cpan.pl.1:
+  removed g-cpan.pl as it's now a standalone tool.
+
+  02 May 2005; Jason Stubbs <jstubbs@gentoo.org> pym/portage.py: Added back
+  support for ~* and * in package.keywords as it got dropped at some point.
+
+*portage-2.0.51.21 (01 May 2005): Maintainence Release
+
+  01 May 2005; Jason Stubbs <jstubbs@gentoo.org> bin/ebuild.sh: Fixed an
+  inverse logic bug in the setting of ccache size.
+
+  01 May 2005; Jason Stubbs <jstubbs@gentoo.org>: Removed g-cpan.pl as it
+  is now maintained externally. Removed other old and/or unmaintained
+  scripts.
+
+  01 May 2005; Jason Stubbs <jstubbs@gentoo.org> pym/portage.py: Dropped
+  confmem from 16 previous files down to 1 previous file so that upgrading
+  and downgrading behaves in terms of config files.
+
   01 May 2005; Jason Stubbs <jstubbs@gentoo.org> pym/portage.py: Added
   checking of overlays for package.mask, categories and others.
 
diff -uNr portage-2.0.51.21/bin/emerge portage-2.0.51.21-r1/bin/emerge
--- portage-2.0.51.21/bin/emerge	2005-05-01 23:53:46.000000000 +0900
+++ portage-2.0.51.21-r1/bin/emerge	2005-05-05 13:08:41.000000000 +0900
@@ -1,7 +1,7 @@
 #!/usr/bin/python -O
 # Copyright 1999-2004 Gentoo Foundation
 # Distributed under the terms of the GNU General Public License v2
-# $Header: /var/cvsroot/gentoo-src/portage/bin/emerge,v 1.345.2.27 2005/04/29 17:43:22 jstubbs Exp $
+# $Header: /var/cvsroot/gentoo-src/portage/bin/emerge,v 1.345.2.28 2005/05/05 03:59:59 jstubbs Exp $
 
 import os,sys
 os.environ["PORTAGE_CALLER"]="emerge"
@@ -1767,10 +1767,25 @@
 				del portage.mtimedb["resume"]["mergelist"][0]
 				del mymergelist[0]
 		else:
+			myfavs=portage.grabfile(portage.root+portage.WORLD_FILE)
+			myfavdict=genericdict(myfavs)
 			for x in range(len(mylist)):
 				if mylist[x][3]!="nomerge":
 					# Add to the mergelist
 					mymergelist.append(mylist[x])
+				else:
+					myfavkey=portage.cpv_getkey(mylist[x][2])
+					if "--onlydeps" in myopts:
+						continue
+					# Add to the world file. Since we won't be able to later.
+					if (not "--fetchonly" in myopts) and (myfavkey in favorites):
+						#don't record if already in system profile or already recorded
+						if (not mysysdict.has_key(myfavkey)) and (not myfavdict.has_key(myfavkey)):
+							#we don't have a favorites entry for this package yet; add one
+							myfavdict[myfavkey]=myfavkey
+							print ">>> Recording",myfavkey,"in \"world\" favorites file..."
+			if not "--fetchonly" in myopts:
+				portage.writedict(myfavdict,portage.root+portage.WORLD_FILE,writekey=0)
 
 			portage.mtimedb["resume"]["mergelist"]=mymergelist[:]
 
diff -uNr portage-2.0.51.21/bin/etc-update portage-2.0.51.21-r1/bin/etc-update
--- portage-2.0.51.21/bin/etc-update	2005-05-01 23:53:46.000000000 +0900
+++ portage-2.0.51.21-r1/bin/etc-update	2005-05-05 13:08:41.000000000 +0900
@@ -1,7 +1,7 @@
 #!/bin/bash
 # Copyright 1999-2004 Gentoo Foundation
 # Distributed under the terms of the GNU General Public License v2
-# $Header: /var/cvsroot/gentoo-src/portage/bin/etc-update,v 1.23.2.3 2005/02/26 11:22:38 carpaski Exp $
+# $Header: /var/cvsroot/gentoo-src/portage/bin/etc-update,v 1.23.2.4 2005/05/05 04:07:02 jstubbs Exp $
 
 # Author Brandon Low <lostlogic@gentoo.org>
 #
@@ -40,8 +40,8 @@
 	for path in ${CONFIG_PROTECT}; do if [ -d ${path} ]; then
 		ofile=""
 		for file in `find ${path}/ -iname "._cfg????_*" |
-			   sed -e "s:\(^.*/\)\(._cfg*_\)\(/.*$\):\1\2\3\%\2\%\3:" |
-			   sort -t'%' -k3 -k2 | cut -f1 -d'%'`; do
+			   sed -e "s:\(^.*/\)\(\._cfg[0-9]*_\)\(.*$\):\1\2\3\%\2\%\3:" |
+			   sort -t'%' -k3 -k2 | LANG=POSIX LC_ALL=POSIX cut -f1 -d'%'`; do
 			rpath=`echo "${file/\/\///}" | sed -e "s:/[^/]*$::"`
 			rfile=`echo "${file/\/\///}" | sed -e "s:^.*/::"`
 			for mpath in ${CONFIG_PROTECT_MASK}; do
Files portage-2.0.51.21/bin/tbz2tool and portage-2.0.51.21-r1/bin/tbz2tool differ
diff -uNr portage-2.0.51.21/cnf/make.globals portage-2.0.51.21-r1/cnf/make.globals
--- portage-2.0.51.21/cnf/make.globals	2005-05-01 23:53:46.000000000 +0900
+++ portage-2.0.51.21-r1/cnf/make.globals	2005-05-05 13:08:41.000000000 +0900
@@ -1,6 +1,6 @@
 # Copyright 1999-2004 Gentoo Foundation
 # Distributed under the terms of the GNU General Public License v2
-# $Header: /var/cvsroot/gentoo-src/portage/cnf/make.globals,v 1.56.2.4 2005/05/01 04:08:54 jstubbs Exp $
+# $Header: /var/cvsroot/gentoo-src/portage/cnf/make.globals,v 1.56.2.5 2005/05/05 03:59:59 jstubbs Exp $
 # System-wide defaults for the Portage system
 
 #            *****************************
@@ -55,7 +55,7 @@
 RSYNC_TIMEOUT="180"
 
 # Minimal CONFIG_PROTECT
-CONFIG_PROTECT="/etc /var /usr/share/config /usr/kde/3/share/config"
+CONFIG_PROTECT="/etc"
 
 #            *****************************
 #            **  DO NOT EDIT THIS FILE  **
diff -uNr portage-2.0.51.21/pym/portage.py portage-2.0.51.21-r1/pym/portage.py
--- portage-2.0.51.21/pym/portage.py	2005-05-02 00:43:17.000000000 +0900
+++ portage-2.0.51.21-r1/pym/portage.py	2005-05-05 13:08:42.000000000 +0900
@@ -1,10 +1,10 @@
 # portage.py -- core Portage functionality
 # Copyright 1998-2004 Gentoo Foundation
 # Distributed under the terms of the GNU General Public License v2
-# $Header: /var/cvsroot/gentoo-src/portage/pym/portage.py,v 1.524.2.68 2005/05/01 12:46:51 jstubbs Exp $
-cvs_id_string="$Id: portage.py,v 1.524.2.68 2005/05/01 12:46:51 jstubbs Exp $"[5:-2]
+# $Header: /var/cvsroot/gentoo-src/portage/pym/portage.py,v 1.524.2.70 2005/05/02 07:22:31 jstubbs Exp $
+cvs_id_string="$Id: portage.py,v 1.524.2.70 2005/05/02 07:22:31 jstubbs Exp $"[5:-2]
 
-VERSION="2.0.51.21"
+VERSION="2.0.51.21-r1"
 
 # ===========================================================================
 # START OF IMPORTS -- START OF IMPORTS -- START OF IMPORTS -- START OF IMPORT
@@ -5632,6 +5632,8 @@
 				matches = match_to_list(mycpv, pkgdict[cp].keys())
 				for atom in matches:
 					pgroups.extend(pkgdict[cp][atom])
+			hasstable = False
+			hastesting = False
 			for gp in mygroups:
 				if gp=="*":
 					writemsg("--- WARNING: Package '%s' uses '*' keyword.\n" % mycpv)
@@ -5643,6 +5645,12 @@
 				elif gp in pgroups:
 					match=1
 					break
+				elif gp[0] == "~":
+					hastesting = True
+				elif gp[0] != "-":
+					hasstable = True
+			if not match and ((hastesting and "~*" in pgroups) or (hasstable and "*" in pgroups)):
+				match=1
 			if match:
 				newlist.append(mycpv)
 		return newlist
