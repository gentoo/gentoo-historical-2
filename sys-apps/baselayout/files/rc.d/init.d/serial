#!/bin/sh
#RCUPDATE:boot:27:This line is required for script management
#
# rc.serial : set the serial ports up on your machine
# Included with Stampede Linux 0.90
# Copyright 1998 Daniel Robbins
# Distributed under the GPL
#
# Version History:
#	Oct 21 1998 -- v0.9 -- colorized, advanced module detection, kernel 2.0.x and 2.1.x
#                              compatibility check. Right on!

. /etc/rc.d/config/functions
if [ -e /etc/rc.d/config/serial ]
then
	. /etc/rc.d/config/serial
else
	exit 0
fi

SETSERIAL="/sbin/setserial"

# ===================================================================================
# DO NOT CHANGE ANYTHING BELOW THIS LINE UNLESS YOU REALLY KNOW WHAT YOU ARE DOING!!!
# ===================================================================================

no_errs=1
done=""

moduleinserted() {
	local res=`cat /proc/modules | grep serial | cut -f1 -d" "`
	if [ "$res" ]
	then
		if [ "$res" = "serial" ]
		then
			return 1
		fi
	fi
	return 0
}

setport() {
	# arguments: device, irq, port, args

	#if serial module exists, and it's not inserted, insert it permanently
	if [ -f /lib/modules/`uname -r`/misc/serial.o ]
	then
		moduleinserted;
		if [ $? -eq 0 ]
		then
			insmod serial 1>&2
		fi
	fi

	ebegin "Setting /dev/${1}"
	${SETSERIAL} -b /dev/${1} irq ${2} port ${3} ${4} 1>&2
	if [ $? -gt 0 ]
	then
		eend 1 "Error setting serial port ${1} to irq ${2} port ${3} (args: ${4})"
		no_errs=0
	else
		eend 0
		done="${done} /dev/${1}"
	fi
}

setports;

