--- module-init-tools-0.9.14/modprobe.c.orig	2003-09-15 22:41:32.252740832 +0200
+++ module-init-tools-0.9.14/modprobe.c	2003-09-15 23:10:44.895298664 +0200
@@ -1148,6 +1148,7 @@ int main(int argc, char *argv[])
 	int strip_vermagic = 0;
 	int strip_modversion = 0;
 	int ignore_proc = 0;
+	int set_config_file = 0;
 	enum noexists_response noexists = NOEXISTS_ERROR;
 	enum exists_response exists = EXISTS_ERROR;
 	unsigned int i, num_modules;
@@ -1184,8 +1185,12 @@ int main(int argc, char *argv[])
 			buf.release[sizeof(buf.release)-1] = '\0';
 			break;
 		case 'C':
+			/* We should not add this to the environment if we might
+			 * still change it below (hack for old modutils compatibility)
 			add_to_env_var("-C");
 			add_to_env_var(optarg);
+			*/
+			set_config_file = 1;
 			config = optarg;
 			break;
 		case 'D':
@@ -1294,16 +1299,27 @@ int main(int argc, char *argv[])
 	   modprobe with -C /etc/modules.conf or /etc/modules.devfs,
 	   to work.  FIXME. */
 	/* Modern devfsd or variants should use -Q explicitly in 2.6. */
-	if (config && !dump_only && strncmp(argv[optind], "/dev/", 5) == 0) {
-		if (strcmp("/etc/modules.conf", config) == 0) {
-			quiet = 1;
-			config = NULL;
-		} else if (strcmp("/etc/modules.devfs", config) == 0) {
-			config = MODPROBE_DEVFSD_CONF;
+	if (!quiet && config && !dump_only && strncmp(argv[optind], "/dev/", 5) == 0) {
+		if (strcmp("/etc/modules.conf", config) == 0
+			|| strcmp("/etc/modules.devfs", config) == 0
+			|| strcmp(MODPROBE_DEVFSD_CONF, config) == 0) {
+			add_to_env_var("-Q");
 			quiet = 1;
+
+			if (strcmp("/etc/modules.conf", config) == 0)
+				config = NULL;
+			else
+				config = MODPROBE_DEVFSD_CONF;
 		}
 	}
 
+	if (set_config_file && !dump_only) {
+		/* Ok, now add the config file to the MODPROBE_OPTIONS
+		 * environment variable */
+		add_to_env_var("-C");
+		add_to_env_var(config);
+	}
+
 	if (dump_only) {
 		struct module_command *commands = NULL;
 		struct module_options *modoptions = NULL;
