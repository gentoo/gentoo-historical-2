From c07321e220df325c315f2138b05ef70146fed5ad Mon Sep 17 00:00:00 2001
From: Dave Airlie <airlied@linux.ie>
Date: Mon, 20 Oct 2008 18:46:49 -0700
Subject: [PATCH 1/4] Default kernel mode setting to off, add configure flag to enable

Should help avoid unpleasantness.
---
 configure.ac |   21 ++++++++++++++-------
 1 files changed, 14 insertions(+), 7 deletions(-)

diff --git a/configure.ac b/configure.ac
index 67ccbdf..a53b225 100644
--- a/configure.ac
+++ b/configure.ac
@@ -75,6 +75,11 @@ AC_ARG_ENABLE(xvmc, AC_HELP_STRING([--disable-xvmc],
               [XVMC="$enableval"],
               [XVMC=auto])
 
+AC_ARG_ENABLE(kms, AC_HELP_STRING([--enable-kms],
+                                  [Enable kernel mode setting support [[default=no]]]),
+              [KMS="$enableval"],
+              [KMS=no])
+
 # Checks for extensions
 XORG_DRIVER_CHECK_EXT(XINERAMA, xineramaproto)
 XORG_DRIVER_CHECK_EXT(RANDR, randrproto)
@@ -107,13 +112,15 @@ if test x$DRI != xno; then
                       [have_dristruct_h="yes"], [have_dristruct_h="no"])
 	AC_CHECK_FILE([${sdkdir}/damage.h],
                       [have_damage_h="yes"], [have_damage_h="no"])
-	AC_CHECK_HEADER(xf86drmMode.h,
-			[DRM_MODE=yes],[DRM_MODE=no]
-			[#include "stdint.h"])
-	dnl exaGetPixmapDriverPrivate required for DRM_MODE.
-	PKG_CHECK_MODULES(DRM_MODE, [xorg-server >= 1.5], [], [DRM_MODE=no])
-	if test "x$DRM_MODE" = xyes; then
-	   	AC_DEFINE(XF86DRM_MODE,1,[DRM kernel modesetting])
+	if test x$KMS != xno; then
+		AC_CHECK_HEADER(xf86drmMode.h,
+				[DRM_MODE=yes],[DRM_MODE=no]
+				[#include "stdint.h"])
+		dnl exaGetPixmapDriverPrivate required for DRM_MODE.
+		PKG_CHECK_MODULES(DRM_MODE, [xorg-server >= 1.5], [], [DRM_MODE=no])
+		if test "x$DRM_MODE" = xyes; then
+	   		AC_DEFINE(XF86DRM_MODE,1,[DRM kernel modesetting])
+		fi
 	fi
 fi
 AC_MSG_CHECKING([whether to include DRI support])
-- 
1.6.0.2

