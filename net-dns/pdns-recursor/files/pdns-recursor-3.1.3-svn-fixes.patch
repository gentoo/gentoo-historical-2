Index: pdns_recursor.cc
===================================================================
--- pdns_recursor.cc	(revision 903)
+++ pdns_recursor.cc	(revision 915)
@@ -652,7 +652,7 @@
     if(bytes==1)
       conn->state=TCPConnection::BYTE1;
     if(bytes==2) { 
-      conn->qlen=(conn->data[0]<<8)+conn->data[1];
+      conn->qlen=(((unsigned char)conn->data[0]) << 8)+ (unsigned char)conn->data[1];
       conn->bytesread=0;
       conn->state=TCPConnection::GETQUESTION;
     }
@@ -664,10 +664,10 @@
     }
   }
   else if(conn->state==TCPConnection::BYTE1) {
-    int bytes=recv(conn->fd,conn->data+1,1,0);
+    int bytes=recv(conn->fd, conn->data+1, 1, 0);
     if(bytes==1) {
       conn->state=TCPConnection::GETQUESTION;
-      conn->qlen=(conn->data[0]<<8)+conn->data[1];
+      conn->qlen=(((unsigned char)conn->data[0]) << 8)+ (unsigned char)conn->data[1];
       conn->bytesread=0;
     }
     if(!bytes || bytes < 0) {
@@ -680,7 +680,7 @@
     }
   }
   else if(conn->state==TCPConnection::GETQUESTION) {
-    int bytes=recv(conn->fd,conn->data + conn->bytesread,conn->qlen - conn->bytesread, 0);
+    int bytes=recv(conn->fd, conn->data + conn->bytesread, conn->qlen - conn->bytesread, 0);
     if(!bytes || bytes < 0) {
       L<<Logger::Error<<"TCP client "<< conn->remote.toString() <<" disconnected while reading question body"<<endl;
       TCPConnection tmp(*conn);
Index: syncres.cc
===================================================================
--- syncres.cc	(revision 901)
+++ syncres.cc	(revision 919)
@@ -16,6 +16,7 @@
     Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
 */
 
+#include <boost/algorithm/string.hpp>
 #include "utility.hh"
 #include "syncres.hh"
 #include <iostream>
@@ -855,9 +856,18 @@
 	return RCode::NXDomain;
       }
       if(!newtarget.empty()) {
+	if(iequals(newtarget,qname)) {
+	  LOG<<prefix<<qname<<": status=got a CNAME referral to self, returning SERVFAIL"<<endl;
+	  return RCode::ServFail;
+	}
+	if(depth > 10) {
+	  LOG<<prefix<<qname<<": status=got a CNAME referral, but recursing too deep, returning SERVFAIL"<<endl;
+	  return RCode::ServFail;
+	}
 	LOG<<prefix<<qname<<": status=got a CNAME referral, starting over with "<<newtarget<<endl;
+
 	set<GetBestNSAnswer>beenthere2;
-	return doResolve(newtarget, qtype, ret,0,beenthere2);
+	return doResolve(newtarget, qtype, ret, depth + 1, beenthere2);
       }
       if(nsset.empty() && !d_lwr.d_rcode) {
 	LOG<<prefix<<qname<<": status=noerror, other types may exist, but we are done "<<(negindic ? "(have negative SOA)" : "")<<endl;
