--- linux-2.6.9/net/unix/af_unix.c	2004-11-24 08:23:21 -08:00
+++ linux-2.6.9.plasmaroo/net/unix/af_unix.c	2004-11-24 08:23:21 -08:00
@@ -1535,9 +1535,11 @@
 
 	msg->msg_namelen = 0;
 
+	down(&u->readsem);
+
 	skb = skb_recv_datagram(sk, flags, noblock, &err);
 	if (!skb)
-		goto out;
+		goto out_unlock;
 
 	wake_up_interruptible(&u->peer_wait);
 
@@ -1587,6 +1589,8 @@
 
 out_free:
 	skb_free_datagram(sk,skb);
+out_unlock:
+	up(&u->readsem);
 out:
 	return err;
 }
