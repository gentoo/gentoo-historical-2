--- src/http/modules/proxy/ngx_http_proxy_upstream.c	Mon Apr 18 18:00:53 2005
+++ src/http/modules/proxy/ngx_http_proxy_upstream.c	Tue Apr 19 16:31:48 2005
@@ -1175,7 +1175,7 @@
 
         rc = ngx_http_parse_header_line(p->request, p->header_in);
 
-        if (rc == NGX_OK) {
+        if (rc == NGX_OK && !r->invalid_header) {
 
             /* a header line has been parsed successfully */
 
@@ -1241,6 +1241,10 @@
             return;
 
         } else if (rc != NGX_AGAIN) {
+
+            if (r->invalid_header) {
+                rc = NGX_HTTP_PARSE_INVALID_HEADER;
+            }
 
             /* there was error while a header line parsing */
 
