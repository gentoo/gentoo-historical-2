#!/sbin/runscript
# Copyright 1999-2005 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: /var/cvsroot/gentoo-x86/net-firewall/iptables/files/iptables.init,v 1.7 2005/05/13 01:50:32 vapier Exp $

opts="save reload"

depend() {
	need net
	use logger
}

checkrules() {
	if [ ! -f ${IPTABLES_SAVE} ]
	then
		eerror "Not starting iptables. First create some rules then run"
		eerror "/etc/init.d/iptables save"
		return 1
	fi
}

start() {
	checkrules || return 1
	ebegin "Loading iptables state and starting firewall"
	einfo "Restoring iptables ruleset"
	/sbin/iptables-restore ${SAVE_RESTORE_OPTIONS} < ${IPTABLES_SAVE}

	if [ "${ENABLE_FORWARDING_IPv4}" = "yes" ] ; then
		einfo "Enabling forwarding for ipv4"
		echo "1" > /proc/sys/net/ipv4/conf/all/forwarding
	fi

	eend $?
}

stop() {
	ebegin "Stopping firewall"
	# set sane defaults that disable forwarding
	if [ -f /proc/sys/net/ipv4/conf/all/forwarding ] ; then
		echo "0" > /proc/sys/net/ipv4/conf/all/forwarding
	fi

	for a in `cat /proc/net/ip_tables_names`; do
		/sbin/iptables -F -t $a
		/sbin/iptables -X -t $a

		if [ $a == nat ]; then
			/sbin/iptables -t nat -P PREROUTING ACCEPT
			/sbin/iptables -t nat -P POSTROUTING ACCEPT
			/sbin/iptables -t nat -P OUTPUT ACCEPT
		elif [ $a == mangle ]; then
			/sbin/iptables -t mangle -P PREROUTING ACCEPT
			/sbin/iptables -t mangle -P INPUT ACCEPT
			/sbin/iptables -t mangle -P FORWARD ACCEPT
			/sbin/iptables -t mangle -P OUTPUT ACCEPT
			/sbin/iptables -t mangle -P POSTROUTING ACCEPT
		elif [ $a == filter ]; then
			/sbin/iptables -t filter -P INPUT ACCEPT
			/sbin/iptables -t filter -P FORWARD ACCEPT
			/sbin/iptables -t filter -P OUTPUT ACCEPT
		fi
	done
	eend $?
}

reload() {
	ebegin "Flushing firewall"
	for a in `cat /proc/net/ip_tables_names`; do
		/sbin/iptables -F -t $a
		/sbin/iptables -X -t $a
	done
	eend $?

	start
}

save() {
	local ret
	ebegin "Saving iptables state"
	/sbin/iptables-save ${SAVE_RESTORE_OPTIONS} > ${IPTABLES_SAVE}
	ret=$?
	chmod 0600 ${IPTABLES_SAVE}
	eend ${ret}
}
