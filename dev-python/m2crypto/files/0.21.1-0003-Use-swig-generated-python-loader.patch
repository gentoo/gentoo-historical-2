From a0b19d256e834b77fc414b162bc86eabb06d516c Mon Sep 17 00:00:00 2001
From: Joe Julian <jjulian@io.com>
Date: Tue, 19 May 2015 23:54:08 -0700
Subject: [PATCH 3/3] Use swig generated python loader

---
 M2Crypto/__init__.py |  4 ++--
 M2Crypto/m2.py       |  4 +---
 SWIG/Makefile        |  4 ++--
 SWIG/_m2crypto.def   |  2 +-
 SWIG/_m2crypto.i     |  2 +-
 pack.py              |  4 ++--
 setup.py             | 28 +++++++++++++++++++++++-----
 7 files changed, 32 insertions(+), 16 deletions(-)

diff --git a/M2Crypto/__init__.py b/M2Crypto/__init__.py
index e7acfe7..84d90e3 100644
--- a/M2Crypto/__init__.py
+++ b/M2Crypto/__init__.py
@@ -19,7 +19,7 @@ Copyright 2008-2011 Heikki Toivonen. All rights reserved.
 version_info = (0, 21, 1)
 version = '.'.join([str(_v) for _v in version_info])
 
-import __m2crypto
+import m2crypto
 import m2
 import ASN1
 import AuthCookie
@@ -57,4 +57,4 @@ import util
 encrypt=1
 decrypt=0
 
-__m2crypto.lib_init()
+m2crypto.lib_init()
diff --git a/M2Crypto/m2.py b/M2Crypto/m2.py
index e4bb695..516cadb 100644
--- a/M2Crypto/m2.py
+++ b/M2Crypto/m2.py
@@ -25,7 +25,5 @@ Portions created by Open Source Applications Foundation (OSAF) are
 Copyright (C) 2004 OSAF. All Rights Reserved.
 """
 
-from __m2crypto import *
+from m2crypto import *
 lib_init()
-
-
diff --git a/SWIG/Makefile b/SWIG/Makefile
index 505b940..a840955 100644
--- a/SWIG/Makefile
+++ b/SWIG/Makefile
@@ -17,8 +17,8 @@ all:	_m2crypto
 _m2crypto: 	_m2crypto.i
 	swig -python -shadow _m2crypto.i
 	cc -c -fpic $(CFLAGS) $(INCLUDE) $(PYINCLUDE) _m2crypto_wrap.c
-	ld -Bshareable -o __m2crypto.so _m2crypto_wrap.o $(LIBS) 
-	cp _m2crypto.py __m2crypto.so ../M2Crypto
+	ld -Bshareable -o _m2crypto.so _m2crypto_wrap.o $(LIBS) 
+	cp m2crypto.py _m2crypto.so ../M2Crypto
 
 clean:
 	rm -f *_wrap* *.o *.so _*.py *.pyc
diff --git a/SWIG/_m2crypto.def b/SWIG/_m2crypto.def
index 753db2c..3e9d5bc 100644
--- a/SWIG/_m2crypto.def
+++ b/SWIG/_m2crypto.def
@@ -1,2 +1,2 @@
 EXPORTS
-init__m2crypto
+init_m2crypto
diff --git a/SWIG/_m2crypto.i b/SWIG/_m2crypto.i
index 3d779a1..f236536 100644
--- a/SWIG/_m2crypto.i
+++ b/SWIG/_m2crypto.i
@@ -8,7 +8,7 @@
  *
  */
 
-%module(threads=1) _m2crypto
+%module(threads=1) m2crypto
 /* We really don't need threadblock (PyGILState_Ensure() etc.) anywhere.
    Disable threadallow as well, only enable it for operations likely to
    block. */
diff --git a/pack.py b/pack.py
index 0005026..14b4961 100644
--- a/pack.py
+++ b/pack.py
@@ -17,9 +17,9 @@ if __name__ == "__main__":
     os.path.walk(start, zap, "/*.pyc")
 
     if os.name == 'nt':
-        zap_m2 = ("__m2cryptoc.pyd","_m2crypto.py")
+        zap_m2 = ("_m2cryptoc.pyd","m2crypto.py")
     elif os.name == 'posix':
-        zap_m2 = ("__m2crypto.so","_m2crypto.py")
+        zap_m2 = ("_m2crypto.so","m2crypto.py")
     for x in zap_m2:
         try:
             os.remove("%s/M2Crypto/%s" % (start, x))
diff --git a/setup.py b/setup.py
index e7c49eb..0967216 100644
--- a/setup.py
+++ b/setup.py
@@ -19,8 +19,21 @@ except ImportError:
     from distutils.core import setup
     from distutils.command import build_ext
 
+from distutils.util import get_platform
 from distutils.core import Extension
 
+from distutils.command.build import build
+from setuptools.command.install import install
+
+class CustomBuild(build):
+    def run(self):
+        self.run_command('build_ext')
+        build.run(self)
+
+class CustomInstall(install):
+    def run(self):
+        self.run_command('build_ext')
+        self.do_egg_install()
 
 class _M2CryptoBuildExt(build_ext.build_ext):
     '''Specialization of build_ext to enable swig_opts to inherit any 
@@ -49,12 +62,17 @@ class _M2CryptoBuildExt(build_ext.build_ext):
 
         build_ext.build_ext.finalize_options(self)
 
-        opensslIncludeDir = os.path.join(self.openssl, 'include')
+        includeDir = os.path.join(self.openssl, 'include')
+        opensslIncludeDir = os.path.join(self.openssl, 'include', 'openssl')
         opensslLibraryDir = os.path.join(self.openssl, 'lib')
         
         self.swig_opts = ['-I%s' % i for i in self.include_dirs + \
-                          [opensslIncludeDir]]
-        self.swig_opts.append('-includeall')
+                          [opensslIncludeDir, includeDir]]
+        if get_platform() == 'linux-x86_64':
+            self.swig_opts.append('-D__x86_64__')
+        self.swig_opts.append('-outdir')
+        self.swig_opts.append(os.path.join(os.getcwd(),'M2Crypto'))
+        #self.swig_opts.append('-includeall')
         #self.swig_opts.append('-D__i386__') # Uncomment for early OpenSSL 0.9.7 versions, or on Fedora Core if build fails
         #self.swig_opts.append('-DOPENSSL_NO_EC') # Try uncommenting if you can't build with EC disabled
         
@@ -127,7 +145,7 @@ if sys.version_info < (2,4):
     build_ext.build_ext.swig_sources = swig_sources
 
 
-m2crypto = Extension(name = 'M2Crypto.__m2crypto',
+m2crypto = Extension(name = 'M2Crypto._m2crypto',
                      sources = ['SWIG/_m2crypto.i'],
                      extra_compile_args = ['-DTHREADING'],
                      #extra_link_args = ['-Wl,-search_paths_first'], # Uncomment to build Universal Mac binaries
@@ -164,5 +182,5 @@ used to provide SSL for Twisted.''',
 
       ext_modules = [m2crypto],
       test_suite='tests.alltests.suite',
-      cmdclass = {'build_ext': _M2CryptoBuildExt}
+      cmdclass = {'build': CustomBuild, 'install': CustomInstall, 'build_ext': _M2CryptoBuildExt}
       )
-- 
2.4.1

