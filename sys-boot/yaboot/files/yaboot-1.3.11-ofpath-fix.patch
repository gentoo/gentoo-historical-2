diff -ruN yaboot-1.3.11.orig/ybin/ofpath yaboot-1.3.11/ybin/ofpath
--- yaboot-1.3.11.orig/ybin/ofpath	2004-03-31 01:53:42.429814600 +0200
+++ yaboot-1.3.11/ybin/ofpath	2004-03-28 06:58:21.000000000 +0200
@@ -27,7 +27,7 @@
 
 PATH="/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin"
 PRG="${0##*/}"
-VERSION=1.0.5
+VERSION=1.0.6-pre2
 DEBUG=0
 export LC_COLLATE=C
 
@@ -297,7 +297,7 @@
 	    DEVICE_PATH="$(printhost $SCSI_HOSTNUMBER $HOST_LIST)"
 	    echo "${DEVICE_PATH##*device-tree}/@$DEVICE_ID:$PARTITION"
 	    ;;
-	ata_k2)
+	ata_k2|sata_svw)
 	    HOST_LIST="$(for i in `find /proc/device-tree -name compatible` ; do
 			lgrep "$i" "k2-s-ata" ; done)"
 	    DEVICE_PATH="$(printhost $SCSI_HOSTNUMBER $HOST_LIST)"
@@ -323,11 +323,32 @@
 	echo 1>&2 "$PRG: BUG: IDEBUS == NULL"
 	return 1
     fi
-    local OF1275IDE="/proc/ide/$IDEBUS/devspec"
+
+    case "$(uname -r)" in
+	2.5.*|2.6.0*|2.6.1|2.6.1-*|2.6.2|2.6.2-*)
+	    echo "$PRG: Linux kernel `uname -r` is not supported"
+	    return 1
+	    ;;
+	2.6.*|2.7.*)
+	    if ! (grep -q '.* .* sysfs ' /proc/mounts 2> /dev/null) ; then
+		echo 1>&2 "$PRG: sysfs must be mounted for ofpath to support this system"
+		return 1
+	    fi
+	    local SYS="$(m=`grep '.* .* sysfs ' /proc/mounts | head -n 1` ; echo `d=${m#* };echo ${d%% *}`)"
+	    if [ -z "$SYS" -o ! -d "$SYS" ] ; then
+		echo 2>&1 "$PRG: Unable to determine sysfs mountpoint"
+		return 1
+	    fi
+	    local OF1275IDE="${SYS}/block/${DEVNODE}/device/../../devspec"
+	    ;;
+	*)
+	    local OF1275IDE="/proc/ide/$IDEBUS/devspec"
+	    ;;
+    esac
 
     if [ ! -f "$OF1275IDE" ] ; then
 	case "$(cat /proc/device-tree/model)" in
-	    "PowerMac3,6")
+	    PowerMac3*|PowerMac4*|PowerMac5*|PowerMac6*|PowerMac7*|X*)
 		local CDROM="$(grep "^drive name:" /proc/sys/dev/cdrom/info 2> /dev/null | grep $DEVNODE)"
 		if [ -z "$CDROM" ] ; then
 		    echo 1>&2 "$PRG: WARNING: Your kernel is too old for proper support, device may be innaccurate."
