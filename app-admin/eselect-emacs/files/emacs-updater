#!/bin/bash

# Licensed under GPL version 2
# Authors:
# Christian Faulhammer <opfer@gentoo.org>
# Ulrich Mueller <ulm@gentoo.org>

VERSION=0.4
SITELISP=/usr/share/emacs/site-lisp
TMPFILE="$(mktemp /tmp/emacs-updater.XXXXXX)"

cat <<-EOF

Emacs updater version ${VERSION}
Written by the Gentoo Emacs team http://www.gentoo.org/proj/en/lisp/emacs/
Find packages that are installed in the wrong location

EOF

# Read in all command-line options and force English output
OPTIONS=$(LC_ALL=C getopt -o hpn --long help,pretend,nocolour \
     -n 'emacs-updater' -- "$@")

eval set -- "${OPTIONS}"

while true
do
    case "${1}" in
	-h|--help) echo "You have the following options: --pretend|-p and/or --no-colour|-n" ; exit 0 ;;
	-p|--pretend) PRETEND="true"; shift 1 ;;
	-n|--nocolour) NOCOLOUR="true"; shift 1;;
	--) shift ; break ;;
    esac
done

# Only set colours if output is not redirected or the --no-colour
# option is not set
if tty -s <&1 && [ -z ${NOCOLOUR} ] ; then
    BLUE=$'\e[34;01m'
    GREEN=$'\e[32;01m'
    RED=$'\e[31;01m'
    YELLOW=$'\e[33;01m'
    CYAN=$'\e[36;01m'
    BOLD=$'\e[0;01m'
    NORMAL=$'\e[0m'
fi

message() {
    local OUTPUT=$@
    echo "${GREEN}*${NORMAL}${BOLD} ${OUTPUT}${NORMAL}"
}

warning() {
    local OUTPUT=$@
    echo "${YELLOW}*${NORMAL}${BOLD} ${OUTPUT}${NORMAL}"
}

failure() {
    local OUTPUT=$@
    echo "${RED}*${NORMAL}${BOLD} ${OUTPUT}${NORMAL}" 
}

if ! [ -x /usr/bin/qfile ]; then
    echo
    failure "Please emerge app-portage/portage-utils to use this tool"
    exit 1
fi

for sf in "${ROOT}${SITELISP}"/[0-9][0-9]*-gentoo.el
do
    [ "${sf##*/}" = 00site-gentoo.el ] && continue
    message "Processing ${sf##*/} ..."
    qfile -qCR "${sf}" >> "${TMPFILE}"
done
echo

if [ ! -s "${TMPFILE}" ]; then
    warning "No packages to update, quitting."
    exit 2
fi

message "Packages with site files in the wrong location:"
cat "${TMPFILE}"

if [ ${PRETEND} ]; then
    exit 3
fi

echo
echo -n "${BOLD}Remerge packages?${NORMAL} [${GREEN}Yes${NORMAL}/${RED}No${NORMAL}] "
read choice
echo
case "${choice}" in
    y*|Y*|"")
	;;
    *)
	warning "Quitting."
	exit 10 ;;
esac

emerge --oneshot --ask --verbose $(cat "${TMPFILE}")

warning "If a package is being rebuilt over and over again,"
warning "please report it on http://bugs.gentoo.org/"
