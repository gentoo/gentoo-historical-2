#!/bin/bash
# Gentoo Mirror Selection Tool
# Copyright 2003 Mark Guertin <gerk@gentoo.org>
# Distributed under the GPL v2
# Jan 30, 2003

# Re-Written May 9, 2003
# John Mylchreest <johnm@gentoo.org>

grab_list() {
	if [ -z "${MIRROR_LIST}" ] ; then
		# Grab mirrorlist into:
		# URL>Description (Location)
		# we will cut whichever neccessary later

		MIRROR_LIST=$(wget -O - "http://www.gentoo.org/main/en/mirrors.xml" 2>/dev/null | \
		(read i; while [ "$(echo $i | tr -d '\r')" != "" ]; do read i; done; cat) | \
		awk '/<a href=\".*tp:.*\".*\(.*\)/ { print $0 }' | grep -v "MIRRORS" | \
		sed 's:<a href="::' | sed 's:"::g' | sed 's:</a><br>::g' | sed 's:\t::g' )
	fi
}


write_config() {
	echo "Found: ${MIRRORS}"
	echo "Updating /etc/make.conf..."

	# If we dont have any mirrors, we should probably give up :)
	if [ ! "`echo $MIRRORS`" ] ; then
		echo "no mirrors selected, exiting"
		exit 1
	fi

	# never seen this before - keeping it in because its obviously caused problems.
	if [ "`echo $MIRRORS | grep \"Can't make\"`" ] ; then
	        echo "Error, screen too small.  Please use at least 80x24 terminal"
	        exit 1
	fi

	# adjust settings in make.conf, all in one command to avoid complaints of make.conf being moved
	mv /etc/make.conf /etc/make.conf.old && cat /etc/make.conf.old | \
	egrep -e "^[^#]*GENTOO_MIRRORS=[^ \t\n]" -v > /etc/make.conf && \
	echo "GENTOO_MIRRORS=\"$MIRRORS\"" >> /etc/make.conf

	# triple check, it make.conf doesn't exist and make.conf.old doesn, replace it and warn user that
	# something didn't work

	if [ ! -s /etc/make.conf ] ; then
		echo "make.conf didn't get remade, something is wrong, reverting to old one"
		mv /etc/make.conf.old /etc/make.conf
	else
		if [ "`grep GENTOO_MIRRORS /etc/make.conf`" ] ; then 
			echo "Mirrors set successfully"
			rm /etc/make.conf.old
		else
			echo "Failed updating make.conf"
		fi
	fi
}


if [ "${1}" = "-a" ] ; then
	# Check we have <num>
	if [ "`echo ${2} | grep -e "^-s[0-9]"`" ] ; then
		SERVERS="${2}"
	else
		if [ "${2}" ] ; then
			echo "${2} is an invalid option"
			exit 
		fi
	fi

	# Ok now we grab the list
	if [ "${3}" != "-o" ] ; then
		echo "Downloading a list of mirrors..."
	fi
	grab_list

	# Format list properly
	# we want just URI's
	CHECKLIST="`echo $MIRROR_LIST | sed 's:http\::\nhttp\::g' | sed 's:ftp\::\nftp\::g' | cut -f1 -d">"`"

	# Pick the mirror from list
	if [ "${3}" != "-o" ] ; then
		echo "Running netselect on the serverlist, this may take a moment..."
	fi

	CHOSEN=`netselect $SERVERS ${CHECKLIST} | awk -F" " '{ print $2 }'`
	for i in $CHOSEN
	do
		MIRRORS="${MIRRORS} $i"
	done

	if [ "${3}" != "-o" ] ; then
		write_config
	else
		echo "GENTOO_MIRRORS=\"${MIRRORS}\""
	fi

elif [ "${1}" = "-i" ] ; then
	echo "Downloading a list of mirrors"
	grab_list

	# Format list properly
	# we want Name (Loc)
	CHECKLIST="`echo $MIRROR_LIST | sed 's:http\::\nhttp\::g' | sed 's:ftp\::\nftp\::g' | sed 's:>:(:g' | cut -f1,3 -d"(" | sed 's: ::g' | sed 's:(: (:g' | sed 's:):) OFF:g' | sed 's:/ftp):):g' | sort`"

	MIRRORS=`dialog --title "GENTOO MIRRORS LIST" \
		--checklist "Please select your desired mirror(s):" 20 80 14 \
		$CHECKLIST 2>&1 | sed "s:\"::g"`

	write_config
else
	echo "mirrorselect usage:"
	echo "-------------------"
	echo "   -a [-s<num>] [-o] : Automatically pick the top performing <num> servers."
	echo "                       if -s was not specified, it returns the top 1."
	echo "                       if -o is present it outputs only the GENTOO_MIRRORS line"
	echo "   -i                : Interactive mode. This downloads a list of mirrors"
	echo "                       and presents them in a checklist"
fi
