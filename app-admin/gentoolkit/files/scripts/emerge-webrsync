#! /bin/sh

# Copyright(c) 2002 Gentoo Technologies, Inc.
# Author: Karl Trygve Kalleberg
# Rewritten from the old, Perl-based emerge-webrsync script

. /etc/make.conf

syncpath="/var/tmp/emerge-webrsync"

if [ ! -f $syncpath ] ; then
	mkdir -p $syncpath
fi

cd $syncpath

found=0

attempts=0

while (( $attempts <  40 )) ; do

	day=`date -d "-$attempts day" +"%d"`
	month=`date -d "-$attempts day" +"%m"`
	year=`date -d "-$attempts day" +"%Y"`

	file="portage-${year}${month}${day}.tar.bz2"

	for i in $GENTOO_MIRRORS ; do 
		url="${i}/snapshots/$file"
		echo $url
		wget $url && ( 
			tar xjf $file
			rm $file
			rsync -av . /usr/
			exit 0 )
	done
	attempts=$[attempts+1]
done

rm -rf portage
