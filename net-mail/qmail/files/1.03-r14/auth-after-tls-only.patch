diff -urbBw qmail-1.03.orig/qmail-smtpd.c qmail-1.03/qmail-smtpd.c
--- qmail-1.03.orig/qmail-smtpd.c	2003-11-30 00:09:49.000000000 -0800
+++ qmail-1.03/qmail-smtpd.c	2003-11-30 00:20:43.000000000 -0800
@@ -175,6 +175,7 @@
 int err_noauth() { out("504 auth type unimplemented (#5.5.1)\r\n"); return -1; }
 int err_authabrt() { out("501 auth exchange cancelled (#5.0.0)\r\n"); return -1; }
 int err_input() { out("501 malformed auth input (#5.5.4)\r\n"); return -1; }
+int err_wantstarttls() { out("530 Must issue a STARTTLS command first (#5.7.0)\r\n"); return -1; };
 
 stralloc greeting = {0};
 
@@ -480,19 +481,30 @@
   size_buf[fmt_ulong(size_buf,(unsigned long) databytes)] = 0;
   out("\r\n250-SIZE "); out(size_buf); 
 }
+
+void smtp_authout() {
+#ifdef AUTHCRAM
+  out("\r\n250-AUTH LOGIN CRAM-MD5 PLAIN"
+      "\r\n250-AUTH=LOGIN CRAM-MD5 PLAIN");
+#else //AUTHCRAM
+  out("\r\n250-AUTH LOGIN PLAIN"
+      "\r\n250-AUTH=LOGIN PLAIN");
+#endif //AUTHCRAM
+}
+
 void smtp_ehlo(arg) char *arg;
 {
   smtp_greet("250-");
-#ifdef AUTHCRAM
-  out("\r\n250-AUTH LOGIN CRAM-MD5 PLAIN");
-  out("\r\n250-AUTH=LOGIN CRAM-MD5 PLAIN");
-#else
-  out("\r\n250-AUTH LOGIN PLAIN");
-  out("\r\n250-AUTH=LOGIN PLAIN");
-#endif
 #ifdef TLS
   if (!ssl) out("\r\n250-STARTTLS");
-#endif
+#endif //TLS
+
+#ifdef TLS && TLS_BEFORE_AUTH 
+  if(ssl) smtp_authout();
+#else // TLS && TLS_BEFORE_AUTH
+  smtp_authout();
+#endif // TLS && TLS_BEFORE_AUTH
+  
   smtp_size();
   out("\r\n250-PIPELINING\r\n250 8BITMIME\r\n");
   seenmail = 0; dohelo(arg);
@@ -879,6 +891,9 @@
 {
   int r;
 
+#ifdef TLS && TLS_BEFORE_AUTH
+  if (!ssl) return err_wantstarttls();
+#endif
   if (*arg) {
     if (r = b64decode(arg,str_len(arg),&user) == 1) return err_input();
   }
@@ -903,6 +918,9 @@
 {
   int r, id = 0;
 
+#ifdef TLS && TLS_BEFORE_AUTH
+  if (!ssl) return err_wantstarttls();
+#endif
   if (*arg) {
     if (r = b64decode(arg,str_len(arg),&slop) == 1) return err_input();
   }
@@ -929,6 +947,10 @@
   int i, r;
   char *s;
 
+#ifdef TLS && TLS_BEFORE_AUTH
+  if (!ssl) return err_wantstarttls();
+#endif
+
   s = unique;
   s += fmt_uint(s,getpid());
   *s++ = '.';
