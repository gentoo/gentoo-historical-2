#!/bin/bash
# Copyright 1999-2005 Gentoo Foundation
# Distributed under the terms of the GNU General Public License v2
# $Header: /var/cvsroot/gentoo-x86/www-client/update-nsplugins/files/update-nsplugins-1.0,v 1.1 2005/07/23 09:17:47 azarah Exp $

ROOT=${ROOT:-/}

source "${ROOT}/etc/nsplugins.conf"

NSPLUGINS_DIR="${ROOT}${NSPLUGINS_DIR}"
NSBROWSERS_DIR="${ROOT}${NSBROWSERS_DIR}"
CACHE_DIR="${NSPLUGINS_DIR}/.cache"

install_plugins() {
	local browser_plugin_dir="${ROOT}$1"

	for x in "${NSPLUGINS_DIR}"/* ; do
		local plugin_name=${x##*/}
		
		[[ -f ${x} || -L ${x} ]] && \
			ln -snf "${x}" "${browser_plugin_dir}/${plugin_name}"
	done
}

uninstall_plugins() {
	local browser_plugin_dir="${ROOT}$1"

	for x in "${browser_plugin_dir}"/* ; do
		[[ -L ${x} ]] && \
			rm -f "${x}"
	done
}

main() {
	local x
	
	mkdir -p "${CACHE_DIR}"

	# Install plugin symlinks
	for x in "${NSBROWSERS_DIR}"/* ; do
		if [[ -f ${x} ]] ; then
			local browser_plugin_dir="${ROOT}$(< "${x}")"

			if [[ -d "${browser_plugin_dir}" ]] ; then
				install_plugins "${browser_plugin_dir}"
				cp -f "${x}" "${CACHE_DIR}/${x}"
			fi
		fi
	done

	# Remove old invalid symlinks for uninstalled browsers
	for x in "${CACHE_DIR}"/* ; do
		local browser_name=${x##*/}

		if [[ -f ${x} && ! -f ${NSBROWSERS_DIR}/${browser_name} ]] ; then
			local browser_plugin_dir="${ROOT}$(< "${x}")"

			if [[ -d "${browser_plugin_dir}" ]] ; then
				uninstall_plugins "${browser_plugin_dir}"
				rm -f "${x}"
			fi
		fi
	done
}

if [[ $UID != 0 ]]; then
	echo "$0: You need to be root to update the plugins" >&2
	return 1
fi

main
