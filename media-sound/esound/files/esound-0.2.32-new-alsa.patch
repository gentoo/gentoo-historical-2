--- acconfig.h-dist	2003-08-01 06:56:21.000000000 -0700
+++ acconfig.h	2004-01-09 23:01:42.620951280 -0800
@@ -8,6 +8,7 @@
 #undef DRIVER_ALSA
 #undef DRIVER_NEWALSA
 #undef DRIVER_ALSA_09
+#undef DRIVER_ALSA_09_AFTER_RC4
 #undef DRIVER_DART
 #undef DRIVER_COREAUDIO
 #undef DRIVER_NONE
--- audio_alsa09.c-dist	2003-03-20 00:34:19.000000000 -0800
+++ audio_alsa09.c	2004-01-09 23:08:55.405986649 -0800
@@ -136,15 +136,24 @@
 		alsaerr = -1;
 		return handle;
 	}
-  
+#ifndef DRIVER_ALSA_09_AFTER_RC4
 	err = snd_pcm_hw_params_set_rate_near(handle, hwparams, speed, 0);
+#else
+	int t_dir=0;
+	int t_speed=speed;
+	err = snd_pcm_hw_params_set_rate_near(handle, hwparams, &t_speed, &t_dir);
+#endif
 	if (err < 0) {
 		if (alsadbg)
 			fprintf(stderr, "%s\n", snd_strerror(err));
 		alsaerr = -1;
 		return handle;
 	}
+#ifndef DRIVER_ALSA_09_AFTER_RC4
 	if (err != speed) {
+#else
+	if (t_speed != speed) {
+#endif
 		if (alsadbg)
 			fprintf(stderr, "Rate not avaliable %i != %i\n", speed, err);
 		alsaerr = -1;
@@ -176,8 +185,12 @@
 		alsaerr = -1;
 		return handle;
 	}
-  
+#ifndef DRIVER_ALSA_09_AFTER_RC4
 	err = snd_pcm_hw_params_set_buffer_size_near(handle, hwparams, BUFFERSIZE); 
+#else
+	snd_pcm_uframes_t t_bufsize=BUFFERSIZE;
+	err = snd_pcm_hw_params_set_buffer_size_near(handle, hwparams, &t_bufsize);
+#endif
 	if (err < 0) { 
 		if (alsadbg)
 			fprintf(stderr, "Buffersize:%s\n", snd_strerror(err)); 
--- configure.in-dist	2003-09-03 09:23:23.000000000 -0700
+++ configure.in	2004-01-09 23:50:32.092247517 -0800
@@ -269,6 +269,22 @@
       AC_CHECK_FUNC(snd_cards,,[AC_CHECK_LIB(sound,snd_cards)])
       AC_CHECK_FUNC(snd_cards,,[AC_CHECK_LIB(asound,snd_cards)])
       AC_CHECK_FUNC(snd_pcm_pause,,[AC_CHECK_LIB(asound,snd_pcm_pause)])
+
+      dnl Check if ALSA uses new API
+      CFLAGS="${CFLAGS} -Werror"
+      AC_TRY_LINK([
+	  #include <alsa/asoundlib.h>
+	  ], [
+	  snd_pcm_t *pcm;
+	  snd_pcm_hw_params_t *params;
+	  unsigned int val;
+	  int dir;
+	  /* intentionally uses non-pointers, trying to replicate bug 129709 */
+	  snd_pcm_hw_params_set_rate_near(pcm, params, val, dir);
+	  ], , [
+	  AC_DEFINE(DRIVER_ALSA_09_AFTER_RC4)
+	  ])
+
    fi
 else
    AC_DEFINE(DRIVER_NONE)
