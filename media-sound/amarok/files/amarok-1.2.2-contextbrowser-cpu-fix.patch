Index: amarok/src/contextbrowser.cpp
===================================================================
RCS file: /home/kde/kdeextragear-1/amarok/src/contextbrowser.cpp,v
retrieving revision 1.416
diff -u -p -r1.416 contextbrowser.cpp
--- amarok/src/contextbrowser.cpp	15 Mar 2005 13:14:21 -0000	1.416
+++ amarok/src/contextbrowser.cpp	15 Mar 2005 21:31:39 -0000
@@ -36,12 +36,12 @@
 #include <kio/job.h>
 #include <kio/jobclasses.h>
 #include <klocale.h>
-#include <kmdcodec.h> // for dataUrlFromImage()
 #include <kmessagebox.h>
 #include <kpopupmenu.h>
 #include <krun.h>
 #include <kstandarddirs.h> //locate file
 #include <ktabbar.h>
+#include <ktempfile.h>
 #include <kurl.h>
 
 #define escapeHTML(s)     QString(s).replace( "&", "&amp;" ).replace( "<", "&lt;" ).replace( ">", "&gt;" )
@@ -79,6 +79,9 @@
         , m_dirtyCurrentTrackPage( true )
         , m_dirtyLyricsPage( true )
         , m_emptyDB( CollectionDB::instance()->isEmpty() )
+        , m_bgGradientImage( 0 )
+        , m_headerGradientImage( 0 )
+        , m_shadowGradientImage( 0 )
         , m_suggestionsOpen( true )
         , m_favouritesOpen( true )
 {
@@ -141,6 +144,9 @@
 
 ContextBrowser::~ContextBrowser()
 {
+     delete m_bgGradientImage;
+     delete m_headerGradientImage;
+     delete m_shadowGradientImage;
 }
 
 
@@ -1384,14 +1390,6 @@
     m_lyricsPage->setUserStyleSheet( m_styleSheet );
 }
 
-static QString dataUrlFromImage( const QImage &img )
-{
-    QByteArray ba;
-    QBuffer buffer( ba );
-    buffer.open( IO_WriteOnly );
-    img.save( &buffer, "PNG" ); // writes image into ba in PNG format
-    return QString("data:image/png;base64,%1").arg( KCodecs::base64Encode( ba ) );
-}
 
 void ContextBrowser::setStyleSheet_Default( QString& styleSheet )
 {
@@ -1405,14 +1403,29 @@
     const QColor bgColor = colorGroup().highlight();
     const amaroK::Color gradientColor = bgColor;
 
+    delete m_bgGradientImage;
+    delete m_headerGradientImage;
+    delete m_shadowGradientImage;
+
+    m_bgGradientImage = new KTempFile( locateLocal( "tmp", "gradient" ), ".png", 0600 );
     QImage image = KImageEffect::gradient( QSize( 600, 1 ), gradientColor, gradientColor.light( 130 ), KImageEffect::PipeCrossGradient );
-    QString bgGradientImage = dataUrlFromImage( image );
+    image.save( m_bgGradientImage->file(), "PNG" );
+    m_bgGradientImage->close();
 
+    m_headerGradientImage = new KTempFile( locateLocal( "tmp", "gradient_header" ), ".png", 0600 );
     QImage imageH = KImageEffect::unbalancedGradient( QSize( 1, 10 ), bgColor, gradientColor.light( 130 ), KImageEffect::VerticalGradient, 100, -100 );
-    QString headerGradientImage = dataUrlFromImage( imageH );
+    imageH.copy( 0, 1, 1, 9 ).save( m_headerGradientImage->file(), "PNG" );
+    m_headerGradientImage->close();
 
+    m_shadowGradientImage = new KTempFile( locateLocal( "tmp", "gradient_shadow" ), ".png", 0600 );
     QImage imageS = KImageEffect::unbalancedGradient( QSize( 1, 10 ), baseColor, Qt::gray, KImageEffect::VerticalGradient, 100, -100 );
-    QString shadowGradientImage = dataUrlFromImage( imageS );
+    imageS.save( m_shadowGradientImage->file(), "PNG" );
+    m_shadowGradientImage->close();
+
+    //unlink the files for us on deletion
+    m_bgGradientImage->setAutoDelete( true );
+    m_headerGradientImage->setAutoDelete( true );
+    m_shadowGradientImage->setAutoDelete( true );
 
     //we have to set the color for body due to a KHTML bug
     //KHTML sets the base color but not the text color
@@ -1420,7 +1433,7 @@
             .arg( pxSize )
             .arg( text )
             .arg( AmarokConfig::schemeAmarok() ? fg : gradientColor.name() )
-            .arg( bgGradientImage )
+            .arg( m_bgGradientImage->name() )
             .arg( fontFamily );
 
     //text attributes
@@ -1442,11 +1455,11 @@
             .arg( fg )
             .arg( bg )
             .arg( pxSize + 2 )
-            .arg( headerGradientImage );
+            .arg( m_headerGradientImage->name() );
 
     styleSheet += QString( ".box-body { padding: 2px; background-color: %1; background-image: url( %2 ); background-repeat: repeat-x; font-size:%3px; }" )
             .arg( colorGroup().base().name() )
-            .arg( shadowGradientImage )
+            .arg( m_shadowGradientImage->name() )
             .arg( pxSize );
 
     //"Albums by ..." related styles
Index: amarok/src/contextbrowser.h
===================================================================
RCS file: /home/kde/kdeextragear-1/amarok/src/contextbrowser.h,v
retrieving revision 1.67
diff -u -p -r1.67 contextbrowser.h
--- amarok/src/contextbrowser.h	14 Mar 2005 19:24:54 -0000	1.67
+++ amarok/src/contextbrowser.h	15 Mar 2005 21:31:39 -0000@@ -15,6 +15,7 @@
@@ -15,6 +15,7 @@
 
 class KHTMLPart;
 class KTabBar;
+class KTempFile;
 
 namespace KIO { class Job; }
 
@@ -82,6 +83,9 @@
         QString       m_lyricAddUrl;
         QString       m_lyricSearchUrl;
         QString       m_HTMLSource;
+        KTempFile    *m_bgGradientImage;
+        KTempFile    *m_headerGradientImage;
+        KTempFile    *m_shadowGradientImage;
         QStringList   m_metadataHistory;
         KURL          m_currentURL;
 
