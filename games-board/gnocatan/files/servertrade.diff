Index: server/player.c
===================================================================
RCS file: /cvsroot/gnocatan/gnocatan/server/player.c,v
retrieving revision 1.37
diff -u -p -r1.37 player.c
--- server/player.c	1 Jan 2004 19:23:09 -0000	1.37
+++ server/player.c	8 Feb 2004 00:43:53 -0000
@@ -402,26 +402,11 @@ void player_archive(Player *player)
 
 	/* If the player was in the middle of a trade, pop the state
 	   machine and inform others as necessary */
+	/* This doesn't quite solve anything, since it is still this
+	 * player's turn, so the others have to wait for the reconnect
+	 * anyway. */
 	state = sm_current(player->sm);
-	if (state == (StateFunc)mode_wait_quote_exit)
-	{
-		sm_pop(player->sm);
-	} 
-	else if (state == (StateFunc)mode_domestic_quote)
-	{
-		for (;;) {
-			QuoteInfo *quote; 
-			quote = quotelist_find_domestic(game->quotes,
-							player->num, -1);
-			if (quote == NULL)
-				break;
-			quotelist_delete(game->quotes, quote);
-		}
-		player_broadcast(player, PB_RESPOND, "domestic-quote finish\n");
-
-		sm_pop(player->sm);
-	}
-	else if (state == (StateFunc)mode_domestic_initiate)
+	if (state == (StateFunc)mode_domestic_initiate)
 	{
 		trade_finish_domestic(player);
 	}
Index: server/trade.c
===================================================================
RCS file: /cvsroot/gnocatan/gnocatan/server/trade.c,v
retrieving revision 1.14
diff -u -p -r1.14 trade.c
--- server/trade.c	1 Jan 2004 19:23:09 -0000	1.14
+++ server/trade.c	8 Feb 2004 00:43:53 -0000
@@ -125,6 +125,27 @@ gboolean mode_wait_quote_exit(Player *pl
 	return FALSE;
 }
 
+static void end_quote (Player *player)
+{
+	/* Player has rejected domestic trade - remove all
+	 * quotes from that player
+	 */
+	for (;;) {
+		QuoteInfo *quote;
+		quote = quotelist_find_domestic(player->game->quotes,
+				player->num, -1);
+		if (quote == NULL)
+			break;
+		quotelist_delete(player->game->quotes, quote);
+	}
+	player_broadcast(player, PB_RESPOND, "domestic-quote finish\n");
+
+	if (player->disconnected)
+		sm_pop (player->sm);
+	else
+		sm_goto(player->sm, (StateFunc)mode_wait_quote_exit);
+}
+
 gboolean mode_domestic_quote(Player *player, gint event)
 {
 	StateMachine *sm = player->sm;
@@ -138,20 +159,7 @@ gboolean mode_domestic_quote(Player *pla
 		return FALSE;
 
 	if (sm_recv(sm, "domestic-quote finish")) {
-		/* Player has rejected domestic trade - remove all
-		 * quotes from that player
-		 */
-		for (;;) {
-			QuoteInfo *quote;
-			quote = quotelist_find_domestic(game->quotes,
-							player->num, -1);
-			if (quote == NULL)
-				break;
-			quotelist_delete(game->quotes, quote);
-		}
-		player_broadcast(player, PB_RESPOND, "domestic-quote finish\n");
-
-		sm_goto(sm, (StateFunc)mode_wait_quote_exit);
+		end_quote (player);
 		return TRUE;
 	}
 
@@ -209,7 +217,7 @@ void trade_finish_domestic(Player *playe
 	     list != NULL; list = player_next_real(list)) {
 		Player *scan = list->data;
 		if (scan != player && scan->num < game->params->num_players)
-			sm_goto(scan->sm, (StateFunc)mode_wait_quote_exit);
+			end_quote (scan);
 	}
 	quotelist_free(game->quotes);
 	game->quotes = NULL;
