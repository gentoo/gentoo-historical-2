To: vim-dev@vim.org
Subject: Patch 6.0.147
Fcc: outbox
From: Bram Moolenaar <Bram@moolenaar.net>
MIME-Version: 1.0
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit
------------

Patch 6.0.147
Problem:    It's not easy to mark a Vim version as being modified.  The new
            license requires this.
Solution:   Add the --modified-by argument to configure and the MODIFIED_BY
            define.  I's used in the intro screen and the ":version" output.
Files:      src/auto/configure, src/configure.in, src/config.h.in,
            src/version.c


*** ../vim60.146/src/auto/configure	Thu Jan 17 12:12:55 2002
--- src/auto/configure	Tue Jan 22 15:34:21 2002
***************
*** 20,25 ****
--- 20,27 ----
  ac_help="$ac_help
    --with-global-runtime=DIR    global runtime directory in 'runtimepath'"
  ac_help="$ac_help
+   --with-modified-by=NAME       name of who modified a rlease version"
+ ac_help="$ac_help
    --with-features=TYPE    tiny, small, normal, big or huge (default: normal)"
  ac_help="$ac_help
    --with-compiledby=NAME  name to show in :version message"
***************
*** 1207,1216 ****
  fi
  
  
  echo $ac_n "checking if character set is EBCDIC""... $ac_c" 1>&6
! echo "configure:1212: checking if character set is EBCDIC" >&5
  cat > conftest.$ac_ext <<EOF
! #line 1214 "configure"
  #include "confdefs.h"
   
  int main() {
--- 1216,1239 ----
  fi
  
  
+ echo $ac_n "checking --with-modified-by argument""... $ac_c" 1>&6
+ echo "configure:1221: checking --with-modified-by argument" >&5
+ # Check whether --with-modified-by or --without-modified-by was given.
+ if test "${with_modified_by+set}" = set; then
+   withval="$with_modified_by"
+   echo "$ac_t""$withval" 1>&6; cat >> confdefs.h <<EOF
+ #define MODIFIED_BY "$withval"
+ EOF
+ 
+ else
+   echo "$ac_t""no" 1>&6
+ fi
+ 
+ 
  echo $ac_n "checking if character set is EBCDIC""... $ac_c" 1>&6
! echo "configure:1235: checking if character set is EBCDIC" >&5
  cat > conftest.$ac_ext <<EOF
! #line 1237 "configure"
  #include "confdefs.h"
   
  int main() {
*** ../vim60.146/src/configure.in	Thu Jan 17 12:12:55 2002
--- src/configure.in	Tue Jan 22 15:33:57 2002
***************
*** 99,104 ****
--- 106,116 ----
  AC_MSG_CHECKING(--with-global-runtime argument)
  AC_ARG_WITH(global-runtime, [  --with-global-runtime=DIR    global runtime directory in 'runtimepath'],
  	AC_MSG_RESULT($withval); AC_DEFINE_UNQUOTED(RUNTIME_GLOBAL, "$withval"),
+ 	AC_MSG_RESULT(no))
+ 
+ AC_MSG_CHECKING(--with-modified-by argument)
+ AC_ARG_WITH(modified-by, [  --with-modified-by=NAME       name of who modified a rlease version],
+ 	AC_MSG_RESULT($withval); AC_DEFINE_UNQUOTED(MODIFIED_BY, "$withval"),
  	AC_MSG_RESULT(no))
  
  dnl Check for EBCDIC stolen from the LYNX port to OS390 Unix
*** ../vim60.146/src/config.h.in	Wed Oct 31 14:21:02 2001
--- src/config.h.in	Tue Jan 22 14:35:41 2002
***************
*** 332,334 ****
--- 332,337 ----
  
  /* Define default global runtime path */
  #undef RUNTIME_GLOBAL
+ 
+ /* Define name of who modified a released Vim */
+ #undef MODIFIED_BY
*** ../vim60.146/src/version.c	Tue Jan 22 14:22:37 2002
--- src/version.c	Tue Jan 22 15:15:52 2002
***************
*** 608,609 ****
--- 608,611 ----
  {   /* Add new patch number below this line */
+ /**/
+     147,
  /**/
***************
*** 1014,1019 ****
--- 1016,1027 ----
  	}
      }
  
+ #ifdef MODIFIED_BY
+     MSG_PUTS("\n");
+     MSG_PUTS(_("Modified by "));
+     MSG_PUTS(MODIFIED_BY);
+ #endif
+ 
  #ifdef HAVE_PATHDEF
      if (*compiled_user != NUL || *compiled_sys != NUL)
      {
***************
*** 1228,1233 ****
--- 1236,1244 ----
  	"",
  	N_("version "),
  	N_("by Bram Moolenaar et al."),
+ #ifdef MODIFIED_BY
+ 	" ",
+ #endif
  	N_("Vim is open source and freely distributable"),
  	"",
  	N_("Help poor children in Uganda!"),
***************
*** 1249,1254 ****
--- 1260,1268 ----
  	NULL,
  	NULL,
  	NULL,
+ #ifdef MODIFIED_BY
+ 	NULL,
+ #endif
  	NULL,
  	NULL,
  	NULL,
***************
*** 1332,1338 ****
      int		col;
      char_u	*p;
      int		l;
!     char_u	buf[100];
  
      /* Center the message horizontally. */
      col = vim_strsize(mesg);
--- 1346,1366 ----
      int		col;
      char_u	*p;
      int		l;
! # define MODBY_LEN 150
!     char_u	buf[MODBY_LEN];
! #ifdef MODIFIED_BY
!     char_u	modby[MODBY_LEN];
! 
!     if (*mesg == ' ')
!     {
! 	STRNCPY(modby, _("Modified by "), MODBY_LEN);
! 	modby[MODBY_LEN - 1] = NUL;
! 	l = STRLEN(modby);
! 	STRNCPY(modby + l, MODIFIED_BY, MODBY_LEN - l);
! 	modby[MODBY_LEN - 1] = NUL;
! 	mesg = modby;
!     }
! #endif
  
      /* Center the message horizontally. */
      col = vim_strsize(mesg);

--  
The 50-50-90 rule: Anytime you have a 50-50 chance of getting 
something right, there's a 90% probability you'll get it wrong.

 ///  Bram Moolenaar -- Bram@moolenaar.net -- http://www.moolenaar.net  \\\
(((   Creator of Vim -- http://vim.sf.net -- ftp://ftp.vim.org/pub/vim   )))
 \\\  Help me helping AIDS orphans in Uganda - http://iccf-holland.org  ///
