Index: digestmd5.c
===================================================================
RCS file: /afs/andrew.cmu.edu/system/cvs/src/sasl/plugins/digestmd5.c,v
retrieving revision 1.145
diff -u -r1.145 cyrus-sasl-2.1.10/plugins/digestmd5.c
--- cyrus-sasl-2.1.10/plugins/digestmd5.c	5 Dec 2002 22:50:42 -0000	1.145
+++ cyrus-sasl-2.1.10-modified/plugins/digestmd5.c	29 Jan 2003 18:12:49 -0000
@@ -3548,7 +3548,7 @@
 
 static int ask_user_info(client_context_t *ctext,
 			 sasl_client_params_t *params,
-			 char **realms,
+			 char **realms, int nrealm,
 			 sasl_interact_t **prompt_need,
 			 sasl_out_params_t *oparams)
 {
@@ -3559,7 +3559,7 @@
     int user_result = SASL_OK;
     int auth_result = SASL_OK;
     int pass_result = SASL_OK;
-    int realm_result = SASL_OK;
+    int realm_result = SASL_FAIL;
 
     /* try to get the authid */
     if (oparams->authid == NULL) {
@@ -3589,21 +3589,29 @@
     }
 
     /* try to get the realm */
-    if (realms && text->realm == NULL) {
-	realm_result = _plug_get_realm(params->utils, (const char **) realms,
-				       (const char **) &realm,
-				       prompt_need);
-	
+    if (text->realm == NULL) {
+	if (realms) {
+	    if(nrealm == 1) {
+		/* only one choice */
+		realm = realms[0];
+		realm_result = SASL_OK;
+	    } else {
+		/* ask the user */
+		realm_result = _plug_get_realm(params->utils,
+					       (const char **) realms,
+					       (const char **) &realm,
+					       prompt_need);
+	    }
+	}
+
+	/* fake the realm if we must */
 	if ((realm_result != SASL_OK) && (realm_result != SASL_INTERACT)) {
-	    /* Fake the realm, if we can. */
 	    if (params->serverFQDN) {
-		_plug_strdup(params->utils, params->serverFQDN,
-			     (char **) &text->realm, NULL);
+		realm = params->serverFQDN;
 	    } else {
 		return realm_result;
 	    }
-	}
-	/* if realm_result == SASL_OK, text->realm has been filled in */
+	}    
     }
     
     /* free prompts we got */
@@ -3665,6 +3673,7 @@
 	if (result != SASL_OK) return result;
     }
 
+    /* Get an allocated version of the realm into the structure */
     if (realm && text->realm == NULL) {
 	_plug_strdup(params->utils, realm, (char **) &text->realm, NULL);
     }
@@ -3711,7 +3720,7 @@
     params->utils->log(params->utils->conn, SASL_LOG_DEBUG,
 		       "DIGEST-MD5 client step 1");
 
-    result = ask_user_info(ctext, params, NULL, prompt_need, oparams);
+    result = ask_user_info(ctext, params, NULL, 0, prompt_need, oparams);
     if (result != SASL_OK) return result;
 
     /* check if we have cached info for this user on this server */
@@ -3797,7 +3806,8 @@
 	}
     }
 
-    result = ask_user_info(ctext, params, realms, prompt_need, oparams);
+    result = ask_user_info(ctext, params, realms, nrealm,
+			   prompt_need, oparams);
     if (result != SASL_OK) goto FreeAllocatedMem;
 
     /*
