#!/bin/bash

source /sbin/functions.sh

if [ ! -f ${HOME}/.pcsx/config ]; then
	einfo You are running PCSX for the first time.
	einfo Setting up your PCSX environment... Please wait...

	mkdir -p ${HOME}/.pcsx
	cd ${HOME}/.pcsx
	mkdir memcards bios cfg plugins

	ln -s /usr/games/bin/pcsx.bin pcsx
	ln -s /usr/games/lib/psemu/plugins/* plugins/
	ln -s /usr/share/games/pcsx .pixmaps

	cd bios
	if [ -f /usr/games/lib/psemu/bios/scph1001.bin ]; then
		ln -s /usr/games/lib/psemu/bios/scph1001.bin .
		biosname=scph1001.bin
	else
		biosname=HLE
	fi
	cd ..

	cat >${HOME}/.pcsx/config <<EOF
Bios = $biosname
Gpu = $(basename $(ls plugins/libgpu* | cut -f1 -d\ ) )
Spu = $(basename $(ls plugins/libspu* | cut -f1 -d\ ) )
Cdr = $(basename $(ls plugins/libcdr* | cut -f1 -d\ ) )
Pad1 = $(basename $(ls plugins/libpadXwin-* | cut -f1 -d\ ) )
Pad2 = $(basename $(ls plugins/libpadXwin-* | cut -f1 -d\ ) )
Mcd1 = ${HOME}/.pcsx/memcards/Mcd001.mcr
Mcd2 = ${HOME}/.pcsx/memcards/Mcd002.mcr
PluginsDir = ${HOME}/.pcsx/plugins/
BiosDir = ${HOME}/.pcsx/bios/
Xa = 0
Sio = 0
Mdec = 0
PsxAuto = 1
PsxType = 0
Cdda = 0
Cpu = 0
PsxOut = 0
SpuIrq = 0
CdTiming = 0
EOF
	unset biosname
fi

cd ${HOME}/.pcsx/

ln -s /usr/games/lib/psemu/cfg/* cfg/ &>/dev/null
ln -s /usr/games/lib/psemu/plugins/* plugins/ &>/dev/null

exec ./pcsx "$@"
