diff -aurN freeradius-1.0.5/src/modules/rlm_digest/rlm_digest.c freeradius-1.0.5-new/src/modules/rlm_digest/rlm_digest.c
--- freeradius-1.0.5/src/modules/rlm_digest/rlm_digest.c	2004-05-15 16:57:41.000000000 +0200
+++ freeradius-1.0.5-new/src/modules/rlm_digest/rlm_digest.c	2005-10-09 02:06:06.000000000 +0200
@@ -35,6 +35,42 @@
 
 static const char rcsid[] = "$Id: freeradius-1.0.5-user-password-ha1.patch,v 1.1 2005/10/16 08:47:36 mrness Exp $";
 
+typedef struct {
+	int           enc_mode;
+} digest_instance;
+
+static CONF_PARSER module_config[] = {
+  {"enc_mode", PW_TYPE_BOOLEAN, offsetof(digest_instance,enc_mode), NULL, "no"},
+  {NULL, -1, 0, NULL, NULL}
+};
+
+static int
+digest_instantiate(CONF_SECTION * conf, void **instance)
+{
+	digest_instance  *inst;
+
+	inst = rad_malloc(sizeof *inst);
+	if (!inst) {
+		return -1;
+	}
+	memset(inst, 0, sizeof(*inst));
+
+	if (cf_section_parse(conf, inst, module_config) < 0) {
+		free(inst);
+		return -1;
+	}
+#ifndef NDEBUG
+	if (inst->enc_mode) {
+	  DEBUG("Encrypting mode set. User-Password field must contain H(A1)");
+	}
+#endif
+	*instance = inst;
+
+
+	return 0;
+
+}
+
 static int digest_authorize(void *instance, REQUEST *request)
 {
 	VALUE_PAIR *vp;
@@ -188,6 +224,7 @@
 	uint8_t hash[16];	/* MD5 output */
 	VALUE_PAIR *vp;
 	VALUE_PAIR *qop, *nonce;
+	digest_instance *inst = instance;
 
 	/*
 	 *	We require access to the plain-text password.
@@ -347,6 +384,21 @@
 	 */
 	librad_md5_calc(&hash[0], &a1[0], a1_len);
 
+	/*
+	 *     If enc_mode is on, User-Password must contain
+	 *     H(A1) itself. Overwrite hash then.
+	 */
+	if (inst->enc_mode) {
+	  DEBUG("User-Password must contain H(A1) , e.g H(username:realm:password)");
+	  vp = pairfind(request->config_items, PW_PASSWORD);
+	  if (!vp) {
+	    DEBUG("ERROR: No User-Password: Cannot perform Digest authentication");
+	    return RLM_MODULE_INVALID;
+	  }
+	  
+	  hex2bin(&hash[0], &vp->strvalue[0]);
+	}
+
 	for (i = 0; i < 16; i++) {
 		sprintf(&kd[i * 2], "%02x", hash[i]);
 	}
@@ -491,7 +543,7 @@
 	"DIGEST",
 	0,				/* type */
 	NULL,				/* initialization */
-	NULL,				/* instantiation */
+	digest_instantiate,				/* instantiation */
 	{
 		digest_authenticate,	/* authentication */
 		digest_authorize, 	/* authorization */
